---
title: "Draft of Figures for Access Paper"
author: "Malavika Rajeev"
date: "12/19/2018"
output: 
  html_document: default
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
rm(list = ls())
library(knitr)
library(RImagePalette)
library(jpeg)
library(tidyverse)
library(lubridate)
library(magrittr)
library(rgdal)
library(broom)
select <- dplyr::select
knitr::opts_chunk$set(fig.pos = 'h', echo = FALSE, message = FALSE, warning = FALSE, results = 'hide')
```

## Goals of this analysis
- To estimate burden of rabies in Madagascar using nationally available bite patient data 
- To explore the potential impacts of expanded access to PEP in Madagascar

## Slide with R Output
## Data
- Patient data from 19 ARMC accross the country over four years (2013 - 2017)
  - includes dates and home locations (to the district level) of patient reporting for PEP
- Patient data from Moramanga ARMC over 28 months (Sep 2016 - Dec 2018)
  - includes dates and home locations (to the commune level) of patients reporting for PEP
  - also includes rabies exposure status based on a combination of clinic-based triage and contact
  tracing (Rajeev et al. 2018)
- Travel times estimated from the Malaria Atlas Project's global friction surface for 2015
- Human population estimates were taken from the 2015 UN adjusted population projections from World Pop

```{r data}
## read in data
ctar_data <- read.csv("data/SaisieRage_DATA_2018-09-21_1755.csv")
ctar_metadata <- read.csv("data/ctar_metadata.csv")
mada_district <- readOGR("data/MadaGIS/MadaPops.shp")
mada_communes <- readOGR("output/communes/communes_extracted.shp")

## catchment data
dist_catchments <- read.csv("output/catchments_district_unmasked.csv", row.names = 1)
names(dist_catchments) <- c("mdg_dis_co", "CTAR", "ttimes_weighted")
comm_catchments <- read.csv("output/catchments_commune_unmasked.csv", row.names = 1)
names(comm_catchments) <- c("mdg_cm_", "CTAR", "ttimes_weighted")

## Centers with no data
no_data <- c("IPM", "Fianarantsoa", "Ambatomainty", "Ambovombe Androy",
             "Antsiranana", "Mandritsara", "Marolambo", "Nosy be", "Sainte Marie",
             "Taolagnaro", "Tsiroanomandidy", "Vangaindrano")
ctar_metadata$exclude <- 0
ctar_metadata$exclude[ctar_metadata$CTAR %in% no_data] <- 1

## Getting ctar district and commune
ctar_metadata$ctar_dist <- mada_district$mdg_dis_co[match(ctar_metadata$District, 
                                                           mada_district$district)]
pts <- SpatialPoints(cbind(ctar_metadata$LONGITUDE, ctar_metadata$LATITUDE), 
                   proj4string = CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))
ctar_metadata$ctar_comm <- over(pts, mada_communes)$mdg_cm_
dist_catchments$ctar_in_dist <- ifelse(dist_catchments$mdg_dis_co %in% ctar_metadata$ctar_dist, 1, 0)
comm_catchments$ctar_in_comm <- ifelse(comm_catchments$mdg_cm_ %in% ctar_metadata$ctar_comm, 1, 0)
``````{r get data}
## read in data
ctar_data <- read.csv("data/SaisieRage_DATA_2018-09-21_1755.csv")
ctar_metadata <- read.csv("data/ctar_metadata.csv")
mada_district <- readOGR("data/MadaGIS/MadaPops.shp")
mada_communes <- readOGR("output/communes/communes_extracted.shp")

## catchment data
dist_catchments <- read.csv("output/catchments_district_unmasked.csv", row.names = 1)
names(dist_catchments) <- c("mdg_dis_co", "CTAR", "ttimes_weighted")
comm_catchments <- read.csv("output/catchments_commune_unmasked.csv", row.names = 1)
names(comm_catchments) <- c("mdg_cm_", "CTAR", "ttimes_weighted")

## Centers with no data
no_data <- c("IPM", "Fianarantsoa", "Ambatomainty", "Ambovombe Androy",
             "Antsiranana", "Mandritsara", "Marolambo", "Nosy be", "Sainte Marie",
             "Taolagnaro", "Tsiroanomandidy", "Vangaindrano")
ctar_metadata$exclude <- 0
ctar_metadata$exclude[ctar_metadata$CTAR %in% no_data] <- 1

## Getting ctar district and commune
ctar_metadata$ctar_dist <- mada_district$mdg_dis_co[match(ctar_metadata$District, 
                                                           mada_district$district)]
pts <- SpatialPoints(cbind(ctar_metadata$LONGITUDE, ctar_metadata$LATITUDE), 
                   proj4string = CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))
ctar_metadata$ctar_comm <- over(pts, mada_communes)$mdg_cm_
dist_catchments$ctar_in_dist <- ifelse(dist_catchments$mdg_dis_co %in% ctar_metadata$ctar_dist, 1, 0)
comm_catchments$ctar_in_comm <- ifelse(comm_catchments$mdg_cm_ %in% ctar_metadata$ctar_comm, 1, 0)
```

## Summary of analyses: Data
- Cleaning data
  - excluded contacts with suspect cases
  - estimated clinic level underreporting (i.e. incomplete submission of forms)
  - average number of annual bites corrected by clinic level underreporting at the district level
- Travel times
  - calculated weighted mean of travel times by human population summed to the commune level 
  - For each clinic, we defined the catchment area as all communes for which the clinic 
  was the closest ARMC.

## Figure 1: Catchment network and distribution of patient travel

```{r network fig}
## Network fig
## Revise: points = CTAR points with size proportional to number of bites reported, lines to district proportional to the number of bites from that district, outline = by district, communes = polygons shaded by catchments?

## Get color palette from other network fig!
add.alpha <- function(col, alpha=1){
  if(missing(col))
    stop("Please provide a vector of colours.")
  apply(sapply(col, col2rgb)/255, 2, 
                     function(x) 
                       rgb(x[1], x[2], x[3], alpha=alpha))  
}
ctar_metadata$color <- c("#FCC56F","#FFDBE5", "#7A4900", "#CBCDD2", "#0000A6", "#EFF2F1",
                 "#63FFAC", "#B79762", "#004D43", "#8FB0FF", "#997D87", "#FD9C54", "#8362B5",
                 "#578FB0","#5A0007", "#809693", "#D16100", "#1B4400", "#4FC601", "#3B5DFF", 
                 "#4A3B53", "#FF2F80","#61615A", "#BA0900", "#6B7900", "#00C2A0", "#FFAA92",
                 "#FF90C9", "#B903AA", "#FEFFE6", "#E9E9D2")
ctar_metadata$fill <- ctar_metadata$color
ctar_metadata$fill[ctar_metadata$CTAR %in% no_data] <- "#D3D3D3"
ctar_metadata$fill <- add.alpha(ctar_metadata$fill, 0.25)

display_palette(ctar_metadata$color)
dist_catchments %>% left_join(select(ctar_metadata, CTAR, exclude, 
                                     color, fill, ctar_dist, LATITUDE, LONGITUDE)) -> dist_catchments
mada_district@data <- left_join(mada_district@data, dist_catchments)

## get exposure matrix
ctar_data %>% 
  group_by(district, id_ctar) %>% # group by district and ctar
  summarize(n = n()) -> exp_mat # get count of exposures
dist_points <- cbind(select(mada_district@data,
                            mdg_dis_co), coordinates(mada_district))
names(dist_points)[2:3] <- c("dist_long", "dist_lat")
dist_points %>%
 left_join(select(ctar_metadata, ctar_dist, LATITUDE, LONGITUDE), 
           by = c("mdg_dis_co" = "ctar_dist")) %>%
 mutate(dist_long = coalesce(dist_long, LONGITUDE), 
        dist_lat = coalesce(dist_lat, LATITUDE)) -> dist_points

exp_mat %>% 
  left_join(select(dist_points, mdg_dis_co, dist_long, dist_lat), 
            by = c("district" = "mdg_dis_co")) %>%
  left_join(select(ctar_metadata, id_ctar, LATITUDE, LONGITUDE,
                   color, fill, ctar_dist)) -> dist_lines
dist_lines %>% 
  group_by(id_ctar) %>%
  summarise(n = sum(n)) %>%
  left_join(select(ctar_metadata, id_ctar, ctar_dist, LATITUDE, LONGITUDE, color)) -> ctar_points
ctar_points$size <- log(ctar_points$n + 0.1)*0.4
dist_lines$size <- log(dist_lines$n + 0.1)*0.2

ctar_data %>%
  group_by(district) %>%
  summarize(n = n()) %>%
  right_join(select(dist_points, mdg_dis_co, dist_long, dist_lat),
             by = c("district" = "mdg_dis_co")) %>%
  left_join(dist_catchments, by = c("district" = "mdg_dis_co")) -> dist_points
dist_points$size <- log(dist_points$n + 0.1)*0.25

pdf("figs/network.pdf")
plot(mada_district, col = mada_district$fill, border = "grey") 
points(ctar_points$LONGITUDE, ctar_points$LATITUDE, pch = 20, cex = dist_points$size, 
       col = ctar_points$color)
segments(dist_lines$dist_long, dist_lines$dist_lat, x1 = dist_lines$LONGITUDE, y1 = dist_lines$LATITUDE, lwd = dist_lines$size*2, col = dist_lines$color)
dev.off()

exp_mat %>% 
  left_join(select(ctar_metadata, CTAR, id_ctar)) %>%
  left_join(select(dist_catchments, mdg_dis_co, CTAR, exclude), by = c("district" = "mdg_dis_co")) %>%
  filter(exclude == 0) %>%
  group_by(district) %>%
  mutate(prop = n/sum(n),
         catch_match = ifelse(CTAR.x == CTAR.y, 1, 0)) -> catch_check
hist(catch_check$prop[catch_check$catch_match == 1], main = "", xlab = "Proportion patients reporting \n within catchment", col = "grey50", border = "white")

```

## Figure 2: Adjustment for reporting
```{r clinic level reporting}
######### Patient time series
ctar_data %>%
  select(id_ctar, date_de_consultation) %>%
  mutate(date_de_consultation = ymd(date_de_consultation)) %>%
  gather(dose, date_de_consultation, -id_ctar) %>%
  group_by(id_ctar, date_de_consultation) %>%
  summarise(n = n()) -> patient_ts
patient_ts <- patient_ts[!is.na(patient_ts$date_de_consultation), ]
patient_ts$ctar <- ctar_metadata$CTAR[match(patient_ts$id_ctar, ctar_metadata$id_ctar)]
patient_ts <- patient_ts[!is.na(patient_ts$ctar), ]

# ggplot(data = patient_ts, aes(date_de_consultation, ctar)) + 
#   geom_tile(aes(fill = n)) +
#   scale_fill_continuous(type = "viridis", name = "Patients") 

## getting reporting
start_date <- ymd("2014-01-01")
end_date <- ymd("2017-12-31")
ts <- as_tibble(seq(start_date, end_date, by = "day"))

patient_ts %>%
  right_join(ts, by = c("date_de_consultation" = "value")) %>%
  select(id_ctar, date_de_consultation, n) %>%
  spread(id_ctar, n) %>%
  replace(., is.na(.), 0) -> doses_wide
dose_mat <- as.matrix(doses_wide[, 2:(ncol(doses_wide) - 1)])

date_mat <- matrix(NA, nrow(dose_mat), ncol(dose_mat))
for (j in 1:ncol(date_mat)){
  rle(dose_mat[ , j]) %>%
    unclass() %>%
    as.data.frame() %>%
    mutate(end = cumsum(lengths),
         start = c(1, lag(end)[-1] + 1)) %>%
    filter(values == 0, lengths >= 10) -> rles
  for (i in 1:nrow(rles)){
    date_mat[rles$start[i]:rles$end[i], j] <- 0
  }
}

date_mat <- replace(date_mat, is.na(date_mat), 1)
date_mat %>% 
  as_tibble() %>%
  group_by(date = year(doses_wide$date_de_consultation)) %>%
  summarise_all(funs(sum(.)/n())) -> clinic_reporting
colnames(clinic_reporting) <- colnames(doses_wide)[1:(ncol(doses_wide)-1)]
clinic_reporting <- gather(clinic_reporting, id_ctar, prop, -date_de_consultation)
clinic_reporting$ctar <- ctar_metadata$CTAR[match(clinic_reporting$id_ctar, 
                                                  ctar_metadata$id_ctar)]
clinic_reporting$id_ctar <- as.numeric(clinic_reporting$id_ctar)

ggplot(clinic_reporting, aes(x = date_de_consultation, y = ctar, fill = prop)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue")
```


```{r district level exposures}
## districts that are non-reporter and data not available yet CTAR
mada_district@data %>%
select(district = mdg_dis_co, pop = pop2015adj, ttimes_weighted, CTAR, exclude) -> covars

to_exclude <- c(grep("contact", unique(ctar_data$remarque), ignore.case = TRUE, value = TRUE),
                grep("contam", unique(ctar_data$remarque), ignore.case = TRUE, value = TRUE),
                grep("consom", unique(ctar_data$remarque), ignore.case = TRUE, value = TRUE),
                grep("passage", unique(ctar_data$remarque), ignore.case = TRUE, value = TRUE))
to_exclude <- to_exclude[-grep("date", to_exclude, ignore.case = TRUE)]
ctar_data$excl <- 0
ctar_data$excl[ctar_data$remarque %in% to_exclude] <- 1

ctar_data %>% 
  filter(excl != 1) %>% # exclude contacts
  mutate_at(vars(starts_with("date")), funs(ymd(.))) %>% # format dates
  group_by(year = year(date_de_consultation), district, id_ctar) %>% # group by year and district
  summarize(n = n()) -> exposures # get count of exposures

exposures %>%
  rename(date = year) %>%
  left_join(covars) %>% # add pop + ttimes + reporting
  left_join(clinic_reporting) %>%   # add reporting by clinic + year
  filter(exclude == 0, prop > 0.25) -> exps_cleaned 

exps_cleaned %>%
  group_by(district, date) %>%
  mutate(bites = n/prop) %>%
  summarise(bites = sum(bites, na.rm = TRUE)) %>%
  group_by(district) %>%
  summarise(bites = mean(bites)) %>%
  left_join(covars) -> exps_dist

exps_cleaned %>%
  group_by(ctar, date) %>% ## Need to rename CTAR so clear if it's CTAR in catchment vs. ctar of bites...
  mutate(bites = n/prop) %>%
  summarise(bites = sum(bites, na.rm = TRUE)) %>%
  group_by(ctar) %>%
  summarise(bites = mean(bites)) -> exps_ctar

```


```{r ttimes + pop at commune level}
## Need: weighted ttimes, pop, ctar_in, exclude
comm_catchments %>%
  left_join(select(mada_communes@data, pop = MDG__201, mdg_cm_, district = mtch_ds)) -> comm_covars
comm_covars <- filter(comm_covars, ttimes_weighted != "Inf")
comm_covars %>% 
  left_join(select(mada_district@data, mdg_dis_co, district)) -> comm_data
comm_data$exclude <- dist_catchments$exclude[match(comm_data$mdg_dis_co, dist_catchments$mdg_dis_co)]

## Data to include
nrow(comm_data) - sum(comm_data$exclude)
```

## Summary of analyses: Models of bites as a function of travel time, Moramanga District
- Moramanga models to the commune level:
  $$ \mu_{j} = exp(\beta_{t}T_{j} + \beta_{0})\times pop_{j} $$
  $\mu_{j}$ = the mean number of bites in commune $j$ 
- We then estimate the likelihood of observing the bites at the commune level at the Moramanga clinic where bites are a poisson distribution around the mean $\mu_{j}$

## Summary of analyses: Extending this to the district level
- Moramanga models to the commune level:
  $$ \mu_{d} = \sum \limits_{j=1}^jexp(\beta_{t}T_{j} + \beta_{0})\times pop_{j} $$
  $\mu_{d}$ is the mean number of bites in district which is the sum of bites at the commune level given **commune level travel times** $d$
- We then estimate the likelihood of observing the bites at the district level where bites are a poisson distribution around the mean $\mu_{d}$

