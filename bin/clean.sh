#!/bin/bash
usage=$(cat <<-END
    clean [-h] [-dry] [-all] [-pkgdown] [-paper]

    This utility will clean all the outputs generated by these analysis scripts.
    Defaults to cleaning the figs, out, and slurm directories in the analysis
    folder and the logs folder at the top level. Pass additional arguments below
    to control what other files are cleaned. Defaults to moving files into a timestamped
    directory in the archive folder instead of deleting them. Pass the -remove argument
    if you want to delete files permanently.

    accepted options are:
    -h, --help          show help message and exit
    -dry                print the command showing which files will be deleted
    -remove             this will delete files permanently (warning: no way to undo this!)
    -all                will clean all generated files including output, figs,
                        pkgdown docs, and manuscript files
    -pkgdown            clean pkgdown files
    -paper              clean manuscript files
    -logs               clean logs
    -della and -dataraw are two internal options which require access to raw data
    inputs and access to my account on della.
END
)

all=false
act=mv
pkgdown=false
dataraw=false
paper=false
logs=false

# Options
while [ "$1" != "" ]; do
    case $1 in
    -all )                  all=true
                            ;;
    -dry )                  act=dry
                            ;;
    -remove )               act=rm
                            ;;
    -pkgdown )              pkgdown=true
                            ;;
    -dataraw )              dataraw=true
                            ;;
    -paper )                paper=true
                            ;;
    -della )                della=true
                            ;;
    -logs )                 logs=true
                            ;;
    -h | --help  )          echo "$usage"
                            exit
                            ;;
    * )                     echo "$usage"
                            exit 1
    esac
    shift
done

run () {
  if [ $2 = dry ];
  then
    echo Deleting or moving $1
  fi
  if [ $2 = rm ];
  then
    rm -R "$1"
  fi
  if [ $2 = mv ];
  then
     mv "$1" archive/"$foldername"/
  fi
}

if [ "$act" = mv ];
then
  if [ ! -d "archive" ];
  then
  mkdir archive
  fi
foldername=$(date +%Y%m%d_%H%M%S)
mkdir archive/"$foldername"
fi

run logs "$act"
run analysis/out "$act"
run analysis/slurm "$act"
run analysis/figs "$act"

if [ "$della" = true ];
then
echo "Cleaning della, make sure you're VPN'd in!"
ssh -T mrajeev@della.princeton.edu <<HERE
    rm -R  MadaAccess/*
    rm -R /scratch/gpfs/mrajeev/MadaAccess/*
HERE
fi

# Cleaning everything
if [ "$dataraw" = true ];
then
run data-raw/out "$act"
fi

if [ "$pkgdown" = true ] || [ "$all" = true ];
then
run docs "$act"
fi

if [ "$paper" = true ] || [ "$all" = true ];
then
run analysis/paper/subfiles "$act"
fi

if [ "$logs" = true ];
then
run logs "$act"
fi
