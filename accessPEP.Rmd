---
title: "Estimating Access to Rabies Post-Exposure Prophylaxis in Madagascar"
author: ""
date: 
output:
  word_document:
    reference_docx: format_docs/word_styles_reference_01.docx
  pdf_document:
    includes:
      in_header: mystyle.sty
  html_document: default
css: style.css
---

```{r directory, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
rm(list = ls())
require("knitr")
knitr::opts_chunk$set(fig.pos = 'h')
rm(list = ls())
library(RImagePalette)
library(jpeg)
library(tidyverse)
library(lubridate)
library(magrittr)
library(rgdal)
```

## INTRODUCTION

[Start broadly with inequity?]
Inequities in access to healthcare and interventions are a major driver of the burden of disease in human populations. Those most impacted by infectious disease are often those from lower socioeconomic strata and remote populations. Despite the impact of these inequities in shaping disease burden, incorporating these factors into estimations of burden is challenging due to the lack of data resolved to these levels...>
  
<br>

Canine rabies causes an estimated 59,000 human deaths annually. Post-exposure prophylaxis prevents fatalities if delivered in a timely manner, however, access to this intervention is highly limited in areas where the disease is endemic. Data on true rabies exposures in humans and incidence in animals is also lacking in most countries. Often, the only data available are numbers of bite victims reporting to health facilities. 
  
<br>

The majority of rabies burden studies use probability decision tree frameworks to estimate burden of rabies from these data, often with the key assumptions that overall reported bite incidence (i.e. both bites due to non-rabid and rabid animals) are proportional to rabies incidence and that reporting is uniform across space. 

The most recent estimation of burden and the impact of PEP used another approach, using transmission dynamic models as the backbone to predict incidence based on level of vaccination coverage and size of the dog population at the national level. Using transmission dynamic models to estimate incidence improves upon previous studies which may over estimate rabies burden in areas of high reporting and underestimating in areas with low reporting due to the assumption that overall reported bite incidence is proportional to rabies incidence.

<br>

Here, we extend this framework to include spatial access to PEP, using bite patient data from 27 clinics in Madagascar, a rabies endemic country with a largely absent control program in the canine population. Institut Pasteur de Madagascar (IPM) provides PEP at no-cost to the government or to the patients at 31 clinics across the country. PEP is not available at any other public clinics or through the private sector. Given that rabies is endemic in the country and there is effectively no vaccination of domestic dogs, we use predictions of incidence from the dynamic model developed by Hampson et al. 2018 in a no control scenario. We flip the standard decision tree and make the assumption that reported bite incidence reflects access and reporting to PEP rather than differences in rabies incidence, using travel times to clinics as a predictor of reporting in a bayesian state space framework...

## METHODS

### Bite patient data
We used the database of bite patient forms submitted from 27 ARMC between 2011-2014. These were paper forms that were sent to IPM as frequently as monthly to annually by individual clinics. Two clinics, the IPM ARMC and the Fianarantsoa ARMC used computer databases from which the data during this period were extracted and merged to the larger database. These data include details on the location of the bite patient and biting animal (*cite baseline data paper*). We also had the number of doses delivered on an annual basis to each clinic and used this information to estimate submission rates of paper forms to IPM for each clinic as described in (*Moramanga paper + baseline data paper*, using minimum # of doses expected based on clinic throughput). As there were many discrepancies between commune names in the GIS administrative layer and the names written on the forms, we used fuzzy matching to find the closest matching commune names and manually checked these.

RIG data?

<br>

### GIS Data
We use the global friction surface for 2015 generated by the Malaria Atlas Project ( https://map.ox.ac.uk/research-project/accessibility_to_cities/, Weiss et al. 2015,) and GPS points of clinics to get travel time to the nearest ARMC for the country of Madagascar at a 1 x 1 km scale. We then averaged these to the commune level, using administrative shapefiles available trhough the UN Office for the Coordination of Humanitarian Affairs. For each clinic, we defined the catchment area as all communes for which the clinic was the closest ARMC. Population estimates were taken from the 2015 UN adjusted population projections from World Pop (www.worldpop.org, Linaird et al. 2012) and also aggreagated to the commune level. 

<br>

### Model of reporting as a function of travel time
We model the bites reported annually to the clinic ($B_{i,t}$) for each commune using a Bayesian state-space framework as follows:
  
$$ B_{i,t} =  k_{c,t} \times \rho_i \times(R_{i,t} + N_{i,t}) $$
  
$k_{c,t}$ is the annual reporting at the catchment level (the product of the estimated proportion of forms that were submitted and the proportion of patients for which we were able to match commune names for that year).
  
$p_i$ is the reporting of all bites which follows the logistic function:
  
$$ \rho_{i} = \frac{C}{1 + e^{\frac{A - x}{d}}}$$
  
where $C$ is a limiting function on the y-axis that measures probability of attendance when distance is zero, $X$ is the log transformed travel times in minutes, $d$ is the distance decay parameter, and A is an asymptote factor at an inflection point of the model. We fix C to 0.90 (estimated from the Moramanga data), as even at minimal travel times, there are people that do not report bites for other reasons than accessibility (Alegana et al. 2012). 
  
<br>

$N_{i,t}$ is the non-rabid bite incidence as a function of human population size **(Need to think about how to justify this...)**.
    
<br>

$$ N_{i,t} = Poisson(\beta_pP_i)$$
    
<br>

$R_{i,t}$ is drawn from a uniform distribution between the minimum and maximum expected number of human exposures. We calculate this as:
    
<br>

$$r \times D \times p_{exp}$$ 
    
<br>

where $r$ is rabies incidence in dogs in the absence of any vaccination multiplied by the estimated dog population in the commune ($D_i$) and the exposure rate per rabid dogs ($p_{exp}$ = 0.39 persons exposed per rabid dog)(Hampson et al. 2018). We estimate the dog population by using a human:dog ratio of 5 to generate our maximum expected incidence and an HDR of 25 for our minimum expected incidence. As there is little data on dog populations in Madagascar, this range of HDRs encompasses a wide range of HDRs observed across Africa(cite?). 
  
<br>

We use RJAGS (...) to fit this model to our reported bites at the commune level over the 4-year period using non-informative priors (...) for $A$ $d$ and $\beta_p$

<br>

### Model evaluation and prediction
We fitted the model to data from n catchments which had above x% clinic level reporting {$k_c$} for all four years.

We used 

For three other catchments with reporting above x% we used to out-of-fit predict...
Ability to predict average annual/monthly bite incidence by travel time
Ability to predict out-of-fit to other catchments 
(observed to expected mean incidence over 4 year period (monthly or annual)

<br>

### Sensitivity analyses
Sensitivity to R (@ what level of human exposure incidence!)
Simulate and recover params? @ what *true* incidence does p_i become non-identifiable...

<br>

### Exploring alternative scenarios and estimation of burden
We estimate burden of human rabies deaths as follows:

$$ D_i = p_{death}\times (1-\rho_i) \times R_i $$
where $p_{death}$ is the probability of death given an exposure in the absence of PEP, $\rho_i$ is the estimated commune specific reporting probability derived from the model, and $R_i$ is the expected rabies incidence. **We use Monte Carlo? simulation drawing from a dist of incidence to get an average number of expected deaths.** We do not include potential deaths due to imperfect PEP (i.e. not completing at least 3 doses), delays in adminsitration, or lack of RIG.

We consider three scenarios:
1. The baseline with the current clinic locations (n = 31)
2. Expansion of ARMC to one clinic per district (n = 114)
3. Expansion of ARMC to all CSB IIs (n = ...?)

We use data on the location of **CSBs** provided by IPM to regenerate travel times to the nearest ARMC given expansion as per scenario 2 and 3. We then predict the expected reporting rate from the model given these new travel times and compare the relative decreases in burden for the three scenarios.

<br>

## Preliminary data processing

### Getting catchments
- Assigning by minimum average commune travel time to clinic (color corresponds to catchment)
```{r catchments, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
ctar_metadata <- read.csv("data/ctar_metadata.csv")
img <- readJPEG("~/Downloads/Dp0j4GNUwAAPPJV.jpeg")
pal <- image_palette(img, 31)
ctar_metadata$color <- pal

mada_communes <- readOGR("data/MadaGIS/commune_mada.shp")
catchments <- read.csv("output/catchments2.csv")

left_join(catchments, dplyr::select(ctar_metadata, CTAR, color, id_ctar),
            by = c("ctar" = "CTAR")) -> catchments
mada_communes@data <- merge(mada_communes@data, catchments, by.x = "mdg_com_co",
                            by.y = "comm_code")
plot(mada_communes, col = as.character(mada_communes$color), border = NA)
```
**There are some issues with this at the moment, maybe could fix by weighted average of raster value travel times by population. This is sort of expensive computationally, so running on cluster now!

## Submission of forms
- Lack of consistent submission of forms, but we think that this for the most part has to do with gaps in sending of forms to IPM

```{r doses, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
ctar_data <- read.csv("data/SaisieRage_DATA_2018-09-21_1755.csv")

ctar_metadata %>% 
  dplyr::select(id_ctar, starts_with("doses")) %>%
  gather(year, doses, -id_ctar) %>%
  mutate(year = as.numeric(substr(as.character(year), 7, 10))) -> doses

## getting dose time series by clinic
ctar_data %>%
  select(id_ctar, datej0, datej3, datej7, datej28) %>%
  mutate_at(vars(starts_with("date")), funs(ymd(.))) %>%
  gather(dose, date, -id_ctar) %>%
  group_by(id_ctar, date) %>%
  summarise(n = n()) -> dose_ts
dose_ts <- dose_ts[!is.na(dose_ts$date), ]
dose_ts$ctar <- ctar_metadata$CTAR[match(dose_ts$id_ctar, ctar_metadata$id_ctar)]
dose_ts <- dose_ts[!is.na(dose_ts$ctar), ]
                   
## getting theoretical # vials by year
dose_ts %>%
  mutate(year = year(date), vials = ceiling(n/2)) %>%
  group_by(id_ctar, year) %>%
  summarize(vials = sum(vials)) %>%
  left_join(doses) -> dose_comp

ggplot(data = dose_ts, aes(date, ctar)) + 
  geom_tile(aes(fill = n)) +
  scale_fill_continuous(type = "viridis", name = "Patients") 
  
```

Potential solution: 
- if monthly: exclude any months with greater than 14 days consecutively with no reporting if 
- if annually: # days included from above/365 = approximate reporting on an annual basis?

### Commune matching
- For each district, ranked commune name matches by fuzzy matching. For those with partial match distances > 1 and < 10, manually chose matching commune names where possible. All others were set as NA.
- Put this into reporting @ the clinic level (either monthly or annual prop matched)

```{r commune matching, echo = FALSE, message = FALSE, warning = FALSE, results = 'hide'}
commune_matching <- read.csv("data/commune_check_CH.csv")
mada_communes$match <- tolower(str_replace_all(mada_communes$commune,"[^[:graph:]]", "/"))
mada_communes$district <- substr(as.character(mada_communes$mdg_com_co), 1, 8)

mada_communes@data %>%
  select(match, district, mdg_com_co) %>%
  left_join(commune_matching, .) %>%
  select(name, match, district, mdg_com_co) -> comm_matches
 
ctar_data$name <- tolower(str_replace_all(ctar_data$commune,"[^[:graph:]]", "/"))
left_join(ctar_data, comm_matches) %>%
  distinct(record_id, .keep_all = TRUE) -> ctar_data

ctar_data %>%
  group_by(id_ctar) %>%
  summarise(n = n(), unmatched = sum(is.na(mdg_com_co)),
            prop_matched = unmatched/n) -> ctar_data_matched

ctar_metadata <- merge(ctar_metadata, ctar_data_matched)
ctar_metadata <- ctar_metadata[!is.na(ctar_metadata$id_ctar), ]
ggplot(ctar_metadata, aes(CTAR, prop_matched)) +
  geom_point() +
  coord_flip()  +
  ylab(label = "Proportion of patients matched to commune")

```

- Not too great of a job for most of them! Ask Chantal to go back through and match more?

## Overall plan
- Pick best catchments (Toamasina, Ambatodrajaka, Toliara, Manakara, Sambava, Soanierana Ivongo, Moramanga, Anstirabe, Ambositra)
- See if anything comes out even with limited success of commune matching

- Alternatively = by district? Less likely to really capture spatial het in access
- Alternatively = w/ Moramanga data from 2016-2018 only; only one catchment, and where we've been actively working/contact tracing
